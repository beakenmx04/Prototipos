<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Libros</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 32px;
      max-width: 800px;
      width: 100%;
      margin: 20px auto;
    }
    .message-box {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4caf50;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
    }
    .message-box.error {
      background-color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Registro de Libros</h1>

    <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
      <p class="text-sm text-blue-800 font-medium">
        Su ID de Usuario: <span id="userIdDisplay" class="font-bold text-blue-900 break-words">Cargando...</span>
      </p>
    </div>

    <form id="bookForm" class="mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label for="title" class="block text-gray-700 font-medium mb-1">T铆tulo del Libro</label>
          <input type="text" id="title" required class="w-full px-4 py-2 border rounded-lg" placeholder="Ej: Cien a帽os de soledad">
        </div>
        <div>
          <label for="author" class="block text-gray-700 font-medium mb-1">Autor</label>
          <input type="text" id="author" required class="w-full px-4 py-2 border rounded-lg" placeholder="Ej: Gabriel Garc铆a M谩rquez">
        </div>
      </div>
      <div class="mb-6">
        <label for="isbn" class="block text-gray-700 font-medium mb-1">ISBN</label>
        <input type="text" id="isbn" class="w-full px-4 py-2 border rounded-lg" placeholder="Ej: 978-3-16-148410-0">
      </div>
      <button type="submit" class="btn-primary w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold">Registrar Libro</button>
    </form>

    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Libros Registrados</h2>
    <div id="booksList" class="space-y-4">
      <p id="noBooksMessage" class="text-gray-500 text-center hidden">No hay libros registrados a煤n.</p>
    </div>
  </div>

  <div id="messageBox" class="message-box"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC65_73xS1pXS8gD7PT9DoA8o74OOBk448",
      authDomain: "prototipo-34750.firebaseapp.com",
      projectId: "prototipo-34750",
      storageBucket: "prototipo-34750.firebasestorage.app",
      messagingSenderId: "511521364025",
      appId: "1:511521364025:web:9019ab3a4b2fc6c4c095e8",
      measurementId: "G-NK571VCY70"
    };

    const appId = "registro-libros";
    const app = initializeApp(firebaseConfig); //  Conexi贸n a Firebase
    const db = getFirestore(app);             //  Conexi贸n a Firestore
    const auth = getAuth(app);                //  Autenticaci贸n

    const bookForm = document.getElementById("bookForm");
    const booksList = document.getElementById("booksList");
    const userIdDisplay = document.getElementById("userIdDisplay");
    const messageBox = document.getElementById("messageBox");
    const noBooksMessage = document.getElementById("noBooksMessage");

    let userId = null;

    function showMessage(msg, isError = false) {
      messageBox.textContent = msg;
      messageBox.className = "message-box" + (isError ? " error" : "");
      messageBox.style.display = "block";
      setTimeout(() => messageBox.style.display = "none", 3000);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        userIdDisplay.textContent = userId;
        listenForBooks(); //  Conexi贸n a colecci贸n Firestore
      } else {
        await signInAnonymously(auth);
      }
    });

    function listenForBooks() {
      const ref = collection(db, `artifacts/${appId}/users/${userId}/books`);
      const q = query(ref);
      onSnapshot(q, (snapshot) => {
        booksList.innerHTML = "";
        if (snapshot.empty) {
          noBooksMessage.classList.remove("hidden");
        } else {
          noBooksMessage.classList.add("hidden");
          snapshot.forEach((docSnap) => {
            const book = docSnap.data();
            const el = document.createElement("div");
            el.className = "flex justify-between items-center bg-gray-50 rounded-lg p-4 shadow";
            el.innerHTML = `
              <div>
                <p class="font-semibold text-gray-800">${book.title}</p>
                <p class="text-sm text-gray-600">Autor: ${book.author}</p>
                <p class="text-sm text-gray-600">ISBN: ${book.isbn || "N/A"}</p>
              </div>
              <button class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm delete-btn" data-id="${docSnap.id}">Eliminar</button>
            `;
            booksList.appendChild(el);
          });
        }
      });
    }

    bookForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const author = document.getElementById("author").value;
      const isbn = document.getElementById("isbn").value;

      if (!userId) return showMessage("Usuario no autenticado", true);

      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/books`), {
          title, author, isbn, createdAt: new Date()
        });
        showMessage("Libro registrado correctamente.");
        bookForm.reset();
      } catch (err) {
        console.error(err);
        showMessage("Error al registrar libro", true);
      }
    });

    booksList.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        try {
          await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/books`, id));
          showMessage("Libro eliminado.");
        } catch (err) {
          console.error(err);
          showMessage("Error al eliminar libro", true);
        }
      }
    });
  </script>
</body>
</html>
